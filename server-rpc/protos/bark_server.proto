
syntax = "proto3";

package bark_server;

import "core.proto";

/// Public ark service for arkd.
service ArkService {
	rpc Handshake(HandshakeRequest) returns (HandshakeResponse) {}
	rpc GetArkInfo(core.Empty) returns (ArkInfo) {}

	// Get new round since the given round id
	//
	// If no round given, gives all rounds in the past 1.5 x the VTXO lifetime.
	rpc GetFreshRounds(FreshRoundsRequest) returns (FreshRounds) {}
	rpc GetRound(RoundId) returns (RoundInfo) {}

	// * BOARDING *

	rpc RequestBoardCosign(BoardCosignRequest) returns (BoardCosignResponse) {}
	rpc RegisterBoardVtxo(BoardVtxoRequest) returns (core.Empty) {}

	// * ARKOOR PAYMENTS*

	rpc CheckpointedCosignOor(CheckpointedPackageCosignRequest) returns (CheckpointedPackageCosignResponse) {}

	// TODO: Remove in 0.1.0-beta.6
	// It is kept for backward compatiblity
	rpc RequestArkoorPackageCosign(ArkoorPackageCosignRequest) returns (ArkoorPackageCosignResponse) {
		option deprecated = true;
	}


	// * MAILBOX *

	// This method is deprecated.
	// Please use `PostVtxoMailbox`
	rpc PostArkoorPackageMailbox(ArkoorPackage) returns (core.Empty) {
		option deprecated = true;
	}
	// Empty the arkoor mailbox for certain pubkeys.
	//
	// At most 100 pubkeys should be provided.
	// This method is deprecated.
	// Please use `ReadMailbox` or `SubscribeMailbox`.
	rpc EmptyArkoorMailbox(ArkoorVtxosRequest) returns (ArkoorVtxosResponse) {
		option deprecated = true;
	}

	// * SEND LN payments

	rpc RequestLightningPayHtlcCosign(LightningPayHtlcCosignRequest) returns (LightningPayHtlcCosignResponse) {}
	rpc InitiateLightningPayment(InitiateLightningPaymentRequest) returns (core.Empty) {}
	rpc CheckLightningPayment(CheckLightningPaymentRequest) returns (LightningPaymentStatus) {}
	rpc RequestLightningPayHtlcRevocation(RevokeLightningPayHtlcRequest) returns (ArkoorPackageCosignResponse) {}

	// TODO: Remove this once we hit 0.1.0-beta.6 or higher
	rpc StartLightningPayment(LightningPayHtlcCosignRequest) returns (LightningPayHtlcCosignResponse) {
		option deprecated = true;
	}
	// TODO: Remove this once we hit 0.1.0-beta.6 or higher
	rpc FinishLightningPayment(InitiateLightningPaymentRequest) returns (LightningPaymentResult) {
		option deprecated = true;
	}
	// TODO: Remove this once we hit 0.1.0-beta.6 or higher
	rpc RevokeLightningPayment(RevokeLightningPayHtlcRequest) returns (ArkoorPackageCosignResponse) {
		option deprecated = true;
	}

	// * RECEIVE LN payments

	rpc FetchBolt12Invoice(FetchBolt12InvoiceRequest) returns (FetchBolt12InvoiceResponse) {}

	rpc StartLightningReceive(StartLightningReceiveRequest) returns (StartLightningReceiveResponse) {}
	rpc CheckLightningReceive(CheckLightningReceiveRequest) returns (CheckLightningReceiveResponse) {}
	rpc PrepareLightningReceiveClaim(PrepareLightningReceiveClaimRequest) returns (PrepareLightningReceiveClaimResponse) {}
	rpc ClaimLightningReceive(ClaimLightningReceiveRequest) returns (ArkoorPackageCosignResponse) {}

	// * ARK ROUND INTERACTIONS *

	// Subscribe to the round events
	rpc SubscribeRounds(core.Empty) returns (stream RoundEvent) {}
	// Get the last round event
	rpc LastRoundEvent(core.Empty) returns (RoundEvent) {}
	rpc SubmitPayment(SubmitPaymentRequest) returns (SubmitPaymentResponse) {}
	rpc ProvideVtxoSignatures(VtxoSignaturesRequest) returns (core.Empty) {}

	// Submit a non-interactive round participation
	rpc SubmitRoundParticipation(RoundParticipationRequest) returns (RoundParticipationResponse) {}
	rpc RoundParticipationStatus(RoundParticipationStatusRequest) returns (RoundParticipationStatusResponse) {}
	rpc RequestLeafVtxoCosign(LeafVtxoCosignRequest) returns (LeafVtxoCosignResponse) {}
	rpc RequestForfeitNonces(ForfeitNoncesRequest) returns (ForfeitNoncesResponse) {}
	rpc ForfeitVtxos(ForfeitVtxosRequest) returns (ForfeitVtxosResponse) {}
}

message HandshakeRequest {
	optional string bark_version = 1;
}

message HandshakeResponse {
	uint64 min_protocol_version = 1;
	uint64 max_protocol_version = 2;
	// Public Service Announcement, a generalized message from the server to be
	// displayed to the user.
	optional string psa = 3;
}

message ArkInfo {
	string network = 1;
	bytes server_pubkey = 2;
	uint32 round_interval_secs = 3;
	uint32 nb_round_nonces = 4;
	uint32 vtxo_exit_delta = 5;
	uint32 vtxo_expiry_delta = 6;
	uint32 htlc_send_expiry_delta = 7;
	uint32 htlc_expiry_delta = 8;
	optional uint64 max_vtxo_amount = 9;
	uint32 max_arkoor_depth = 10 [deprecated = true];
	uint32 required_board_confirmations = 11;
	uint32 max_user_invoice_cltv_delta = 12;
	uint64 min_board_amount = 13;
	bool ln_receive_anti_dos_required = 15;
	bytes mailbox_pubkey = 16;

	//TODO(stevenroose) move fee related values that are less
	// permanent into another struct for bark to check
	uint64 offboard_feerate_sat_vkb = 14;
	uint64 offboard_fixed_fee_vb = 17;

	// last index: 17
}

message FreshRoundsRequest {
	optional string last_round_txid = 1;
}

message FreshRounds {
	repeated bytes txids = 1;
}

message RoundId {
	bytes txid = 1;
}

message RoundInfo {
	bytes funding_tx = 1;
	bytes signed_vtxos = 2;
}


// boarding

message BoardCosignRequest {
	uint64 amount = 1;
	bytes utxo = 2;
	uint32 expiry_height = 3;
	bytes user_pubkey = 4;
	bytes pub_nonce = 5;
}

message BoardCosignResponse {
	bytes pub_nonce = 1;
	bytes partial_sig = 2;
}

message BoardVtxoRequest {
	bytes board_vtxo = 1;
}


// arkoor

message VtxoRequest {
	uint64 amount = 1;
	bytes policy = 2;
}

message CheckpointedCosignRequest {
	bytes input_vtxo_id = 1;
	repeated VtxoRequest outputs = 2;
	repeated bytes user_pub_nonces = 3;
}

message CheckpointedPackageCosignRequest {
	repeated CheckpointedCosignRequest parts = 1;
}

message CheckpointedCosignResponse {
	repeated bytes server_pub_nonces = 1;
	repeated bytes server_partial_sigs = 2;
}

message CheckpointedPackageCosignResponse {
	repeated CheckpointedCosignResponse parts = 1;
}

/// TODO: Remove in 0.1.0-beta.6
// This is kept for backward compatibility
message ArkoorCosignRequest {
	bytes input_id = 1;
	repeated VtxoRequest outputs = 2;
	bytes pub_nonce = 3;
}


// TODO Remove in 0.1.0-beta.6
// This is kept for backward compatibility
message ArkoorPackageCosignRequest {
	repeated ArkoorCosignRequest arkoors = 1;
}

// TODO: Remove in 0.1.0-beta.6
// This is kept for backward compatibility
message ArkoorCosignResponse {
	bytes pub_nonce = 1;
	bytes partial_sig = 2;
}


// TODO: Remove this in 0.1.0-beta.6
// This is kept for backward compatibility
message ArkoorPackageCosignResponse {
	repeated ArkoorCosignResponse sigs = 1;
}


// mailbox

message ArkoorPackage {
	option deprecated = true;
	repeated ArkoorVtxo arkoors = 1;
}

message ArkoorVtxo {
	option deprecated = true;
	bytes pubkey = 1;
	bytes vtxo = 2;
}

message ArkoorVtxosRequest {
	option deprecated = true;
	repeated bytes pubkeys = 1;
}

message ArkoorMailboxPackage {
	option deprecated = true;
	bytes arkoor_package_id = 1;
	repeated bytes vtxos = 2;
}

message ArkoorVtxosResponse {
	option deprecated = true;
	repeated ArkoorMailboxPackage packages = 1;
}



// lightning

message LightningPayHtlcCosignRequest {
	string invoice = 1;
	optional uint64 user_amount_sat = 2;
	repeated bytes input_vtxo_ids = 3;
	repeated bytes user_nonces = 4;
	bytes user_pubkey = 5;
}

message LightningPayHtlcCosignResponse {
	repeated ArkoorCosignResponse sigs = 1;
	bytes policy = 2;
}

message InitiateLightningPaymentRequest {
	string invoice = 1;
	repeated bytes htlc_vtxo_ids = 2;
	// TODO: Remove this once we hit 0.1.0-beta.6 or higher
	bool wait = 3 [deprecated = true];
}

message CheckLightningPaymentRequest {
	bytes hash = 1;
	bool wait = 2;
}

// TODO: Remove this once we hit 0.1.0-beta.6 or higher
enum PaymentStatus {
	PENDING = 0;
	FAILED = 1;
	SUCCESS = 2;
}

// TODO: Remove this once we hit 0.1.0-beta.6 or higher
message LightningPaymentResult {
	string progress_message = 1;
	PaymentStatus status = 2;
	bytes payment_hash = 3;
	optional bytes payment_preimage = 4;
}

message PaymentSuccessStatus {
	bytes preimage = 1;
}

message LightningPaymentStatus {
	oneof payment_status {
		core.Empty pending = 1;
		PaymentSuccessStatus success = 2;
		core.Empty failed = 3;
	};
}

message RevokeLightningPayHtlcRequest {
	repeated bytes htlc_vtxo_ids = 1;
	repeated bytes user_nonces = 2;
}

message FetchBolt12InvoiceRequest {
	bytes offer = 1;
	optional uint64 amount_sat = 2;
}

message FetchBolt12InvoiceResponse {
	bytes invoice = 1;
}

message StartLightningReceiveRequest {
	bytes payment_hash = 1;
	uint64 amount_sat = 2;
	uint32 min_cltv_delta = 3;
}

message StartLightningReceiveResponse {
	string bolt11 = 1;
}

message CheckLightningReceiveRequest {
	bytes hash = 1;
	bool wait = 2;
}

message PrepareLightningReceiveClaimRequest {
	bytes payment_hash = 1;
	bytes user_pubkey = 2;
	uint32 htlc_recv_expiry = 3;
	oneof lightning_receive_anti_dos {
		InputVtxo input_vtxo = 4;
		string token = 5;
	};
}

message PrepareLightningReceiveClaimResponse {
	CheckLightningReceiveResponse receive = 1;
	repeated bytes htlc_vtxos = 2;
}

message ClaimLightningReceiveRequest {
	bytes payment_hash = 1;
	bytes payment_preimage = 2;
	bytes vtxo_policy = 3;
	repeated bytes user_pub_nonces = 4;
}

enum LightningReceiveStatus {
	// We have created the invoice and are awaiting the sender to start the process
	CREATED = 0;
	// The sender has setup the payment route and it's ready to go
	ACCEPTED = 1;
	// The Ark HTLC is created and ready to be executed with the preimage
	HTLCS_READY = 2;
	// The HTLCs have been executed and the payment was settled
	SETTLED = 3;
	// The payment was canceled before being executed
	CANCELED = 4;
}

message CheckLightningReceiveResponse {
	string invoice = 1;
	uint64 amount_sat = 2;
	LightningReceiveStatus status = 3;
	// Empty until the status is HTLCS_READY or SETTLED
	repeated bytes htlc_vtxos = 4;
}

// round

message RoundAttempt {
	uint64 round_seq = 1;
	uint64 attempt_seq = 2;
	bytes round_attempt_challenge = 3;
}

message ForfeitNonces {
	bytes input_vtxo_id = 1;
	repeated bytes pub_nonces = 2;
}

message VtxoProposal {
	uint64 round_seq = 1;
	uint64 attempt_seq = 2;
	bytes vtxos_spec = 3;
	bytes unsigned_round_tx = 4;
	repeated bytes vtxos_agg_nonces = 5;
}

message RoundFinished {
	uint64 round_seq = 1;
	uint64 attempt_seq = 2;
	/// The signed round tx.
	bytes signed_round_tx = 3;
	/// The cosign signatures to plug into the vtxo tree.
	repeated bytes vtxo_cosign_signatures = 4;
}

message RoundEvent {
	oneof event {
		RoundAttempt attempt = 1;
		VtxoProposal vtxo_proposal = 2;
		RoundFinished finished = 4;

		// old variants:
		//RoundProposal round_proposal = 3;
	};
}

message InputVtxo {
	// vtxo id of input vtxos
	bytes vtxo_id = 1;
	bytes ownership_proof = 2;
}

message SignedVtxoRequest {
	VtxoRequest vtxo = 1;
	bytes cosign_pubkey = 2;
	repeated bytes public_nonces = 3;
}

message OffboardRequest {
	// amount in sats
	uint64 amount = 1;
	bytes offboard_spk = 2;
}

message SubmitPaymentRequest {
	repeated InputVtxo input_vtxos = 2;
	repeated SignedVtxoRequest vtxo_requests = 3;
	repeated OffboardRequest offboard_requests = 4 [ deprecated = true ];
}

message SubmitPaymentResponse {
	bytes unlock_hash = 1;
}

message ForfeitSignatures {
	bytes input_vtxo_id = 1;
	repeated bytes pub_nonces = 2;
	repeated bytes signatures = 3;
}

message VtxoSignaturesRequest {
	/// The cosign pubkey these signatures are for.
	bytes pubkey = 1;
	repeated bytes signatures = 2;
}

message RoundParticipationRequest {
	repeated InputVtxo input_vtxos = 2;
	repeated VtxoRequest vtxo_requests = 3;
}

message RoundParticipationResponse {
	bytes unlock_hash = 1;
}

message RoundParticipationStatusRequest {
	bytes unlock_hash = 1;
}

enum RoundParticipationStatus {
	// participation still waiting to happen
	ROUND_PART_PENDING = 0;
	// new vtxos have been issued, but not released yet
	ROUND_PART_ISSUED = 1;
	// old vtxos have been forfeited and new vtxos released
	ROUND_PART_RELEASED = 2;
}

message RoundParticipationStatusResponse {
	// the actual status
	RoundParticipationStatus status = 1;

	// signed round funding tx
	// (provided if status != ROUND_PART_PENDING)
	optional bytes round_funding_tx = 2;

	// unsigned output vtxos
	// (provided if status != ROUND_PART_PENDING)
	repeated bytes output_vtxos = 3;

	// unlock preimage to unlock new vtxos
	// (provided if status == ROUND_PART_RELEASED)
	optional bytes unlock_preimage = 4;
}

message LeafVtxoCosignRequest {
	bytes vtxo_id = 1;
	bytes public_nonce = 2;
}

message LeafVtxoCosignResponse {
	bytes public_nonce = 1;
	bytes partial_signature = 2;
}

message ForfeitNoncesRequest {
	// the unlock hash to forfeit to, this is the unlock hash that locks the new output VTXO
	bytes unlock_hash = 1;
	// the VTXO IDs of the VTXOs to be forfeited for the same unlock preimage
	repeated bytes vtxo_ids = 2;
}

message ForfeitNoncesResponse {
	// list of nonces, two for each vtxo requested
	repeated bytes public_nonces = 1;
}

message ForfeitVtxosRequest {
	// encoded forfeit bundles, should all be for the same unlock hash
	repeated bytes forfeit_bundles = 1;
}

message ForfeitVtxosResponse {
	bytes unlock_preimage = 1;
}


service WalletAdminService {
	rpc WalletSync(core.Empty) returns (core.Empty) {}
	rpc WalletStatus(core.Empty) returns (WalletStatusResponse) {}
}

service RoundAdminService {
	rpc TriggerRound(core.Empty) returns (core.Empty) {}
}

service LightningAdminService {
	rpc StartLightningNode(LightningNodeUri) returns (core.Empty) {}
	rpc StopLightningNode(LightningNodeUri) returns (core.Empty) {}
}

service SweepAdminService {
	rpc TriggerSweep(core.Empty) returns (core.Empty) {}
}

message WalletStatus {
	string address = 1;
	uint64 total_balance = 2;
	uint64 trusted_pending_balance = 3;
	uint64 untrusted_pending_balance = 4;
	uint64 confirmed_balance = 5;
	repeated string confirmed_utxos = 6;
	repeated string unconfirmed_utxos = 7;
}

message WalletStatusResponse {
	WalletStatus rounds = 1;
	WalletStatus forfeits = 2;
}

message LightningNodeUri {
	string uri = 1;
}
