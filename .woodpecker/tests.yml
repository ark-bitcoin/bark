when:
  - event: pull_request
  - event: manual
  - event: tag
    ref: refs/tags/bark-*
  - event: tag
    ref: refs/tags/server-*
  - evaluate: 'CI_PIPELINE_EVENT == "push" && CI_COMMIT_BRANCH == "master" && CI_REPO_URL == "https://gitlab.com/ark-bitcoin/bark"'

clone:
  - name: clone
    image: woodpeckerci/plugin-git@sha256:2aaacedd7da067f2f6b54a3ef3d39cc69cc0c1152e377fd8df266bd34acd317e
    settings:
      partial: false
      depth: 100
      lfs: false

steps:
  - name: check-commits
    image: registry.2nd.dev/build:27
    commands:
      - sudo chown -R nixuser:nixbld /woodpecker
      - date +"%Y%m%d-%H%M%S" > RUN_DATETIME
      - git log --oneline | head -n 1
      - |
        if [ "${CI_PIPELINE_EVENT}" != "tag" ]; then
          nix develop .#default --command bash -c "just check-commits"
        else
          echo "Skipping check-commits for tag event"
        fi
      - git log --oneline | head -n 1

  - name: build
    depends_on: check-commits
    image: registry.2nd.dev/build:27
    volumes:
      - /data:/host/data
    commands:
      - git log --oneline | head -n 1
      - >
        nix develop .#default --command bash -c "just build"


  - name: compare-static-files
    depends_on: check-commits
    image: registry.2nd.dev/build:27
    commands:
      - >
        nix develop .#default --command bash -c "
          just generate-static-files
        "
      - bash contrib/check-clean-diff.sh bark/schema.sql
      - bash contrib/check-clean-diff.sh server/schema.sql
      - bash contrib/check-clean-diff.sh bark-rest/openapi.json

  - name: test-unit
    depends_on: build
    image: registry.2nd.dev/build:27
    commands:
      - git log --oneline | head -n 1
      - >
        nix develop .#default --command bash -c "just test-unit"

  - name: use-bark-as-dependency
    depends_on: test-unit
    image: registry.2nd.dev/build:27
    commands:
      - >
        nix develop .#default --command bash -c "
          cargo init barktest &&
          cd barktest &&
          cargo add bark-wallet &&
          cargo update &&
          cargo build
        "

  - name: bark-as-libs
    depends_on: test-unit
    image: registry.2nd.dev/build:27
    commands:
      - >
        nix develop .#default --command bash -c "
          cargo build -p bark-wallet      --no-default-features --features=\"\" &&
          cargo build -p bark-bitcoin-ext --no-default-features --features=\"\" &&
          cargo build -p ark-lib          --no-default-features --features=\"\"
        "

  - name: lib-wasm
    depends_on: test-unit
    image: registry.2nd.dev/build:27
    commands:
      - >
        nix develop .#default --command bash -c "
          cd lib/ &&
          cargo build --lib --release --target "wasm32-unknown-unknown" --features wasm-js
        "

  - name: lib-msrv
    depends_on: test-unit
    image: registry.2nd.dev/build:27
    commands:
      - >
        nix develop .#msrv-lib --command bash -c "
          cd testing/msrv-lib &&
          cargo build
        "

  - name: check-release
    depends_on: test-unit
    image: registry.2nd.dev/build:27
    commands:
      - >
        nix develop .#default --command bash -c "
          cargo check --release -p bark-cli &&
          cargo check --release -p bark-server
        "

  - name: test-integration-esplora
    when:
      - event: push
        branch: master
    depends_on: bark-as-libs
    image: registry.2nd.dev/build:27
    volumes:
      - /data:/host/data
    environment:
      CHAIN_SOURCE: esplora
      TEST_DIRECTORY: ./test/esplora
      NEXTEST_TEST_THREADS: 2
      BARK_COMMAND_TIMEOUT_MILLIS: 120000
      TX_PROPAGATION_TIMEOUT: 30000
      CARGO_TARGET_DIR: target-esplora
    privileged: true
    commands:
      - git log --oneline | head -n 1
      - export RUN_DATETIME=$(cat RUN_DATETIME)
      - export CAPTAIND_EXEC=${CI_WORKSPACE}/target-esplora/debug/captaind
      - export BARK_EXEC=${CI_WORKSPACE}/target-esplora/debug/bark
      - bash ./contrib/ci-run-test.sh test-integration

  - name: test-integration-mempool
    depends_on: bark-as-libs
    image: registry.2nd.dev/build:27
    volumes:
      - /data:/host/data
    environment:
      CHAIN_SOURCE: mempool
      TEST_DIRECTORY: ./test/mempool
      NEXTEST_TEST_THREADS: 2
      BARK_COMMAND_TIMEOUT_MILLIS: 120000
      TX_PROPAGATION_TIMEOUT: 30000
      CARGO_TARGET_DIR: target-mempool
    privileged: true
    commands:
      - git log --oneline | head -n 1
      - export RUN_DATETIME=$(cat RUN_DATETIME)
      - export CAPTAIND_EXEC=${CI_WORKSPACE}/target-mempool/debug/captaind
      - export BARK_EXEC=${CI_WORKSPACE}/target-mempool/debug/bark
      - bash ./contrib/ci-run-test.sh test-integration

  - name: test-integration-btc30.2
    depends_on: bark-as-libs
    image: registry.2nd.dev/build:27
    volumes:
      - /data:/host/data
    environment:
      TEST_DIRECTORY: ./test/btc30
      NEXTEST_TEST_THREADS: 2
      BARK_COMMAND_TIMEOUT_MILLIS: 120000
      TX_PROPAGATION_TIMEOUT: 30000
      CARGO_TARGET_DIR: target-btc30
    privileged: true
    commands:
      - git log --oneline | head -n 1
      - export RUN_DATETIME=$(cat RUN_DATETIME)
      - export CAPTAIND_EXEC=${CI_WORKSPACE}/target-btc30/debug/captaind
      - export BARK_EXEC=${CI_WORKSPACE}/target-btc30/debug/bark
      - bash ./contrib/ci-run-test.sh test-integration-client

depends_on:
  - main
